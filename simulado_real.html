<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulado Real Aleat√≥rio</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
      body {
          font-family: "Segoe UI", sans-serif;
          background: linear-gradient(to right, #f2f9ff, #e3ecf7);
          margin: 0;
          padding: 30px 15px;
          color: #333;
          text-align: center;
      }

      #container {
          max-width: 700px;
          margin: auto;
          background: #fff;
          padding: 25px;
          border-radius: 12px;
          box-shadow: 0 5px 30px rgba(0, 0, 0, 0.08);
      }

      h1 {
          margin-bottom: 10px;
          color: #2c3e50;
      }

      p.instrucao {
          font-size: 0.95rem;
          color: #555;
          margin-top: -10px;
          margin-bottom: 20px;
      }

      input[type="file"] {
          display: none;
      }

      #fileLabelZip, #fileLabelJson {
          display: inline-block;
          margin: 10px;
          padding: 12px 24px;
          background-color: #3498db;
          color: white;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          transition: background-color 0.3s ease;
      }

      #fileLabelZip:hover, #fileLabelJson:hover {
          background-color: #2980b9;
      }

      .opcao {
          display: block;
          margin: 10px 0;
          padding: 12px 16px;
          border-radius: 6px;
          border: 2px solid #3498db;
          background: #ecf5ff;
          color: #1e2d40;
          font-weight: 500;
          cursor: pointer;
          text-align: left;
      }

      .opcao:hover {
          background: #d6eaff;
      }

      .correta {
          color: #27ae60;
          font-weight: bold;
          text-align: left;
      }

      .incorreta {
          color: #e74c3c;
          font-weight: bold;
          text-align: left;
      }

      .feedback {
          margin-top: 10px;
          font-style: italic;
          text-align: left;
      }

      button {
          background: #3498db;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          margin-top: 20px;
          font-weight: 600;
          cursor: pointer;
          transition: background-color 0.3s ease;
      }

      button:hover {
          background: #2980b9;
      }

      #timer {
          font-size: 1.3rem;
          margin: 15px 0;
          color: #c0392b;
          font-weight: bold;
      }

      .barra-progresso {
          width: 100%;
          background: #ddd;
          height: 20px;
          border-radius: 10px;
          overflow: hidden;
          margin: 20px auto;
          max-width: 700px;
      }

      .barra-progresso-interna {
          height: 100%;
          background: #3498db;
          width: 0%;
          transition: width 0.4s ease;
      }

      @media (max-width: 600px) {
          #container {
              padding: 20px 15px;
          }

          .opcao {
              font-size: 0.95rem;
          }

          button, #fileLabelZip, #fileLabelJson {
              width: 100%;
              font-size: 1rem;
          }
      }
  </style>
</head>
<body>
<h1>Simulado Real Aleat√≥rio</h1>
<p class="instrucao">üìÅ Escolha como deseja carregar as quest√µes:</p>
<label id="fileLabelJson" for="inputJson">üìÅ Usar arquivos .json (pasta)</label>
<input type="file" id="inputJson" accept=".json" webkitdirectory multiple>
<label id="fileLabelZip" for="inputZip">Arquivo ZIP</label>
<input type="file" id="inputZip" accept=".zip">
<div id="timer">Tempo restante: 60:00</div>
<div class="barra-progresso">
  <div id="barraInterna" class="barra-progresso-interna"></div>
</div>
<div id="container">
  <p>O simulado ser√° carregado automaticamente ap√≥s a escolha.</p>
</div>
<audio id="audioCorreto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="audioErro" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
<script>
	const inputJson = document.getElementById("inputJson");
	const inputZip = document.getElementById("inputZip");
	const container = document.getElementById("container");
	const timerEl = document.getElementById("timer");
	const barra = document.getElementById("barraInterna");
	const audioCorreto = document.getElementById("audioCorreto");
	const audioErro = document.getElementById("audioErro");

	let questoes = [];
	let questaoAtual = 0;
	let acertos = 0;
	let tempoRestante = 60 * 60;
	let intervalo;

	/* inputJson.addEventListener("change", async (event) => {
		const arquivos = Array.from(event.target.files).filter(f => f.name.endsWith(".json"));
		questoes = [];
		for (const arq of arquivos.sort(() => 0.5 - Math.random()).slice(0, 10)) {
			const texto = await arq.text();
			const json = JSON.parse(texto);
			const qs = json.content.questions;
			const aleatoria = qs[Math.floor(Math.random() * qs.length)];
			aleatoria._arquivo = arq.name;
			questoes.push(aleatoria);
		}
		iniciarSimulado();
	});*/

	/*inputZip.addEventListener("change", async (event) => {
		const zipFile = event.target.files[0];
		const zip = await JSZip.loadAsync(zipFile);
		questoes = [];
		for (const nome of Object.keys(zip.files)) {
			if (nome.endsWith(".json")) {
				const conteudo = await zip.files[nome].async("string");
				const json = JSON.parse(conteudo);
				const qs = json.content.questions;
				const aleatoria = qs[Math.floor(Math.random() * qs.length)];
				aleatoria._arquivo = nome;
				questoes.push(aleatoria);
			}
		}
		questoes = questoes.sort(() => 0.5 - Math.random()).slice(0, 10);
		iniciarSimulado();
	});*/

	inputJson.addEventListener("change", async (event) => {
		const arquivos = Array.from(event.target.files).filter(f => f.name.endsWith(".json"));
		const totalQuestoesDesejadas = 10;
		const questoesSelecionadas = [];

		const arquivosQuestoes = [];

		for (const arq of arquivos) {
			try {
				const texto = await arq.text();
				const json = JSON.parse(texto);
				const qs = json?.content?.questions || [];
				if (qs.length > 0) {
					arquivosQuestoes.push({nome: arq.name, questoes: qs});
				}
			} catch (e) {
				console.error(`Erro ao ler o arquivo ${arq.name}:`, e);
			}
		}

		if (arquivosQuestoes.length === 0) {
			alert("Nenhum JSON v√°lido com quest√µes encontrado.");
			return;
		}

		if (arquivosQuestoes.length === 1) {
			const {nome, questoes: qs} = arquivosQuestoes[0];
			const indices = shuffle(qs.length).slice(0, totalQuestoesDesejadas);
			indices.forEach(i => {
				const q = qs[i];
				const opcoes = q.options;
				const ordem = shuffle(opcoes.length);
				q.options = ordem.map(i => opcoes[i]);
				q._arquivo = nome;
				questoesSelecionadas.push(q);
			});
		} else {
			const base = Math.floor(totalQuestoesDesejadas / arquivosQuestoes.length);
			let resto = totalQuestoesDesejadas % arquivosQuestoes.length;

			for (const {nome, questoes: qs} of arquivosQuestoes) {
				const qtd = base + (resto > 0 ? 1 : 0);
				if (resto > 0) resto--;

				const indices = shuffle(qs.length).slice(0, qtd);
				indices.forEach(i => {
					const q = qs[i];
					const opcoes = q.options;
					const ordem = shuffle(opcoes.length);
					q.options = ordem.map(i => opcoes[i]);
					q._arquivo = nome;
					questoesSelecionadas.push(q);
				});
			}
		}

		questoes = questoesSelecionadas;
		iniciarSimulado();
	});

	inputZip.addEventListener("change", async (event) => {
		const zipFile = event.target.files[0];
		const zip = await JSZip.loadAsync(zipFile);

		const arquivosQuestoes = [];

		for (const nome of Object.keys(zip.files)) {
			if (nome.endsWith(".json")) {
				try {
					const conteudo = await zip.files[nome].async("string");
					const json = JSON.parse(conteudo);
					const qs = json?.content?.questions || [];
					if (qs.length > 0) {
						arquivosQuestoes.push({nome, questoes: qs});
					}
				} catch (e) {
					console.error(`Erro ao ler o arquivo ${nome}:`, e);
				}
			}
		}

		const totalQuestoesDesejadas = 10;
		const questoesSelecionadas = [];

		if (arquivosQuestoes.length === 0) {
			alert("Nenhum arquivo JSON v√°lido encontrado.");
			return;
		}

		if (arquivosQuestoes.length === 1) {
			const {nome, questoes: qs} = arquivosQuestoes[0];
			const indices = shuffle(qs.length).slice(0, totalQuestoesDesejadas);
			indices.forEach(i => {
				const q = qs[i];
				const opcoes = q.options;
				const ordem = shuffle(opcoes.length);
				q.options = ordem.map(i => opcoes[i]);
				q._arquivo = nome;
				questoesSelecionadas.push(q);
			});
		} else {
			const base = Math.floor(totalQuestoesDesejadas / arquivosQuestoes.length);
			let resto = totalQuestoesDesejadas % arquivosQuestoes.length;

			for (const {nome, questoes: qs} of arquivosQuestoes) {
				const qtd = base + (resto > 0 ? 1 : 0);
				if (resto > 0) resto--;

				const indices = shuffle(qs.length).slice(0, qtd);
				indices.forEach(i => {
					const q = qs[i];
					const opcoes = q.options;
					const ordem = shuffle(opcoes.length);
					q.options = ordem.map(i => opcoes[i]);
					q._arquivo = nome;
					questoesSelecionadas.push(q);
				});
			}
		}

		questoes = questoesSelecionadas;
		iniciarSimulado();
	});

	function shuffle(n) {
		const arr = Array.from({length: n}, (_, i) => i);
		for (let i = arr.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[arr[i], arr[j]] = [arr[j], arr[i]];
		}
		return arr;
	}


	function iniciarSimulado() {
		acertos = 0;
		questaoAtual = 0;
		iniciarCronometro();
		renderizarQuestao();
	}

	function iniciarCronometro() {
		clearInterval(intervalo);
		intervalo = setInterval(() => {
			if (tempoRestante <= 0) {
				clearInterval(intervalo);
				mostrarResultado("‚è∞ Tempo esgotado!");
				return;
			}
			tempoRestante--;
			const minutos = String(Math.floor(tempoRestante / 60)).padStart(2, "0");
			const segundos = String(tempoRestante % 60).padStart(2, "0");
			timerEl.textContent = `Tempo restante: ${minutos}:${segundos}`;
		}, 1000);
	}

	function atualizarBarra() {
		const percentual = ((questaoAtual) / questoes.length) * 100;
		barra.style.width = percentual + "%";
	}

	function escaparHTML(str) {
		const div = document.createElement("div");
		div.appendChild(document.createTextNode(str));
		return div.innerHTML;
	}

	function renderOpcao(op) {
		const isHTML = op.isHTML ?? true;
		return isHTML ? op.text : escaparHTML(op.text);
	}

	function renderizarQuestao() {
		if (questaoAtual >= questoes.length) {
			clearInterval(intervalo);
			mostrarResultado("üéâ Simulado finalizado!");
			return;
		}

		atualizarBarra();
		const q = questoes[questaoAtual];
		container.innerHTML = `
      <h3 style="text-align: left">${questaoAtual + 1}) ${q.enunciated}</h3>
      <p style="text-align: left"><em>Arquivo: ${q._arquivo}</em></p>
    `;

		q.options.forEach(op => {
			const btn = document.createElement("button");
			btn.className = "opcao";
			btn.innerHTML = renderOpcao(op);
			btn.onclick = () => {
				const correta = q.options.find(o => o.isCorrect);
				const feedback = document.createElement("p");
				const explicacao = document.createElement("div");

				if (op.isCorrect) {
					feedback.innerHTML = "‚úÖ Correto!";
					feedback.className = "correta";
					audioCorreto.play();
					acertos++;
				} else {
					feedback.innerHTML = "‚ùå Incorreto. A correta era: " + correta.text;
					feedback.className = "incorreta";
					audioErro.play();
				}

				explicacao.innerHTML = "üìù " + (op.feedback || "Sem justificativa.");
				explicacao.className = "feedback";

				container.appendChild(feedback);
				container.appendChild(explicacao);

				Array.from(container.getElementsByTagName("button")).forEach(b => b.disabled = true);

				const btnProx = document.createElement("button");
				btnProx.textContent = "Pr√≥xima quest√£o";
				btnProx.onclick = () => {
					questaoAtual++;
					renderizarQuestao();
				};
				container.appendChild(btnProx);
			};
			container.appendChild(btn);
		});
	}

	function mostrarResultado(msg) {
		barra.style.width = "100%";
		container.innerHTML = `
      <h2>${msg}</h2>
      <p>Voc√™ acertou <strong>${acertos}</strong> de <strong>${questoes.length}</strong> quest√µes.</p>
      <button onclick="window.location.reload()">üîÅ Refazer simulado</button>
    `;
	}
</script>
</body>
</html>
