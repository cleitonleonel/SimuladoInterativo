<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulado Interativo Geral</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
      * {
          box-sizing: border-box;
      }

      body {
          font-family: "Segoe UI", sans-serif;
          background: linear-gradient(to bottom right, #eef2f7, #dfe9f3);
          padding: 30px 15px;
          color: #2c3e50;
          margin: 0;
          text-align: center;
      }

      h1, h2, h3 {
          text-align: center;
          color: #34495e;
      }

      #container {
          max-width: 700px;
          margin: auto;
          background: #fff;
          padding: 25px;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
          transition: all 0.3s ease;
      }

      .questao {
          margin-bottom: 30px;
          text-align: left;
      }

      .opcao {
          display: block;
          margin: 10px 0;
          padding: 12px 16px;
          border-radius: 6px;
          border: 2px solid #3498db;
          background: #ecf5ff;
          color: #1e2d40;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          text-align: left;
      }

      .opcao:hover {
          background: #d6eaff;
      }

      .correta {
          color: #27ae60;
          font-weight: bold;
          text-align: left;
      }

      .incorreta {
          color: #e74c3c;
          font-weight: bold;
          text-align: left;
      }

      button {
          background: #3498db;
          color: white;
          padding: 12px 24px;
          border: none;
          border-radius: 6px;
          margin: 20px auto 0;
          font-weight: 600;
          font-size: 1rem;
          cursor: pointer;
          transition: background-color 0.3s ease;
          display: block;
      }

      button:hover {
          background: #2980b9;
      }

      input[type="file"] {
          display: none;
      }

      #fileLabelZip, #fileLabelJson {
          display: inline-block;
          margin: 10px;
          padding: 12px 24px;
          background-color: #3498db;
          color: white;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          transition: background-color 0.3s ease;
      }

      #fileLabelZip:hover, #fileLabelJson:hover {
          background-color: #2980b9;
      }

      .feedback {
          margin-top: 10px;
          font-style: italic;
          text-align: left;
      }

      #progresso {
          max-width: 700px;
          margin: 20px auto;
      }

      .barra {
          width: 100%;
          background: #ddd;
          height: 20px;
          border-radius: 10px;
          overflow: hidden;
          margin-top: 10px;
      }

      .barra div {
          height: 100%;
          background: #3498db;
          width: 0;
          transition: width 0.4s ease;
      }

      .result-arquivo {
          margin-top: 20px;
          background: #fff;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
          text-align: center;
      }

      ul {
          list-style: none;
          padding: 0;
          margin: 0 auto;
          text-align: center;
      }

      ul li {
          margin-bottom: 5px;
          line-height: 1.5;
          text-align: center;
      }

      #resultado {
          max-width: 700px;
          margin: 30px auto;
          padding: 20px;
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
          word-wrap: break-word;
      }

      #resultado h2,
      #resultado h3,
      #resultado p {
          text-align: center;
      }

      @media (max-width: 600px) {
          #container {
              padding: 20px 15px;
          }

          .opcao {
              font-size: 0.95rem;
          }

          button, #fileLabelZip, #fileLabelJson {
              width: 100%;
              font-size: 1rem;
          }

          #resultado {
              padding: 15px;
              font-size: 0.95rem;
          }

          ul li {
              font-size: 0.95rem;
          }
      }
  </style>
</head>
<body>
<h1>Simulado Interativo Geral</h1>
<p>Selecione o tipo de arquivo para iniciar:</p>
<label id="fileLabelJson" for="inputJson">üìÅ Usar arquivos .json (pasta)</label>
<input type="file" id="inputJson" accept=".json" webkitdirectory multiple>
<label id="fileLabelZip" for="inputZip">üóúÔ∏è Usar arquivo .zip</label>
<input type="file" id="inputZip" accept=".zip">
<div id="progresso">
  <label>Progresso:</label>
  <div class="barra">
    <div id="barra-progresso"></div>
  </div>
</div>
<div id="container">
  <p>Ap√≥s escolher o tipo de arquivo, o simulado ser√° iniciado automaticamente.</p>
</div>
<div id="resultado"></div>
<audio id="audioCorreto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="audioErro" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
<script>
	const inputJson = document.getElementById("inputJson");
	const inputZip = document.getElementById("inputZip");
	const container = document.getElementById("container");
	const resultado = document.getElementById("resultado");
	const barra = document.getElementById("barra-progresso");
	const audioCorreto = document.getElementById("audioCorreto");
	const audioErro = document.getElementById("audioErro");

	let arquivos = [];
	let arquivoAtual = 0;
	let questoes = [];
	let questaoAtual = 0;
	let acertosTotal = 0;
	let totalQuestoes = 0;
	let tempos = [];
	let resultadosPorArquivo = [];

	inputJson.addEventListener("change", async (event) => {
		arquivos = Array.from(event.target.files).filter(f => f.name.endsWith(".json")).sort((a, b) => a.name.localeCompare(b.name));
		iniciarSimulado();
	});

	inputZip.addEventListener("change", async (event) => {
		const zipFile = event.target.files[0];
		const zip = await JSZip.loadAsync(zipFile);
		arquivos = [];

		for (const nome of Object.keys(zip.files)) {
			if (nome.endsWith(".json")) {
				const conteudo = await zip.files[nome].async("string");
				const blob = new Blob([conteudo], {type: "application/json"});
				blob.name = nome;
				arquivos.push(blob);
			}
		}
		iniciarSimulado();
	});

	function iniciarSimulado() {
		if (arquivos.length === 0) return;
		arquivoAtual = 0;
		acertosTotal = 0;
		totalQuestoes = 0;
		tempos = [];
		resultadosPorArquivo = [];
		resultado.innerHTML = "";
		carregarArquivo();
	}

	function atualizarBarra() {
		const progresso = ((arquivoAtual + questaoAtual / questoes.length) / arquivos.length) * 100;
		barra.style.width = progresso + "%";
	}

	function shuffle(questions) {
		let i = questions.length, j, temp;
		while (--i > 0) {
			j = Math.floor(Math.random() * (i + 1));
			temp = questions[j];
			questions[j] = questions[i];
			questions[i] = temp;
		}
		return questions;
	}

	function carregarArquivo() {
		const reader = new FileReader();
		reader.onload = function (e) {
			const dados = JSON.parse(e.target.result);
			questoes = shuffle(dados.content.questions);
			questaoAtual = 0;
			resultadosPorArquivo.push({nome: arquivos[arquivoAtual].name, acertos: 0, total: questoes.length});
			renderizarQuestao();
		};
		reader.readAsText(arquivos[arquivoAtual]);
	}

	function escaparHTML(str) {
		const div = document.createElement("div");
		div.appendChild(document.createTextNode(str));
		return div.innerHTML;
	}

	function renderOpcao(op) {
		const isHTML = op.isHTML ?? true;
		return isHTML ? op.text : escaparHTML(op.text);
	}

	function renderizarQuestao() {
		if (questaoAtual >= questoes.length) {
			arquivoAtual++;
			if (arquivoAtual < arquivos.length) {
				carregarArquivo();
			} else {
				mostrarResultado();
			}
			return;
		}

		atualizarBarra();
		const q = questoes[questaoAtual];
		const inicio = Date.now();
		container.innerHTML = "";

		const qDiv = document.createElement("div");
		qDiv.className = "questao";

		const titulo = document.createElement("h3");
		titulo.innerHTML = `Arquivo: ${arquivos[arquivoAtual].name}`;
		qDiv.appendChild(titulo);

		const enunciado = document.createElement("div");
		enunciado.innerHTML = `<strong>${questaoAtual + 1})</strong> ${q.enunciated}`;
		qDiv.appendChild(enunciado);

		q.options.forEach((opcao) => {
			const btn = document.createElement("button");
			btn.className = "opcao";
			btn.innerHTML = renderOpcao(opcao);
			btn.onclick = () => {
				const tempo = ((Date.now() - inicio) / 1000).toFixed(2);
				tempos.push(tempo);
				totalQuestoes++;

				const feedback = document.createElement("p");
				const correta = q.options.find(opt => opt.isCorrect);
				const acertou = opcao.isCorrect;

				feedback.innerHTML = acertou ? "‚úÖ Correto!" : "‚ùå Incorreto.";
				feedback.className = acertou ? "correta" : "incorreta";

				const explicacao = document.createElement("div");
				explicacao.innerHTML = "üìù " + (opcao.feedback || "");
				explicacao.className = "feedback";

				if (!acertou && correta) {
					const corretaDiv = document.createElement("div");
					corretaDiv.className = "correta";
					corretaDiv.style.marginTop = "10px";
					corretaDiv.innerHTML = `‚úîÔ∏è Resposta correta: <br><strong>${correta.text}</strong>`;
					audioErro.play();
					qDiv.appendChild(corretaDiv);
				}

				if (opcao.isCorrect) {
					acertosTotal++;
					audioCorreto.play();
					resultadosPorArquivo[arquivoAtual].acertos++;
				}

				qDiv.appendChild(feedback);
				qDiv.appendChild(explicacao);
				Array.from(qDiv.getElementsByTagName("button")).forEach(b => b.disabled = true);

				const proximo = document.createElement("button");
				proximo.textContent = "Pr√≥xima quest√£o";
				proximo.onclick = () => {
					questaoAtual++;
					renderizarQuestao();
				};
				qDiv.appendChild(proximo);
			};
			qDiv.appendChild(btn);
		});

		container.appendChild(qDiv);
	}

	function mostrarResultado() {
		container.innerHTML = "";
		resultado.innerHTML = `
      <h2>Simulado Conclu√≠do</h2>
      <p>Voc√™ acertou <strong>${acertosTotal}</strong> de <strong>${totalQuestoes}</strong> quest√µes.</p>
      <h3>Tempos de resposta:</h3>
      <ul>${tempos.map((t, i) => `<li>Quest√£o ${i + 1}: ${t}s</li>`).join('')}</ul>
      <h3>Resultado por Arquivo:</h3>
      ${resultadosPorArquivo.map(r =>
			`<div class="result-arquivo"><strong>${r.nome}</strong>: ${r.acertos}/${r.total} acertos</div>`
		).join('')}
    `;
		barra.style.width = "100%";
	}
</script>
</body>
</html>
